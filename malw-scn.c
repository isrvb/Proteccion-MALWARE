#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <clamav.h>

int main(int argc, char **argv) {
    // Inicializar el motor de ClamAV
    int ret;
    const char *virname;
    const char *fdesc = NULL;
    struct cl_engine *engine;
    ret = cl_init(CL_INIT_DEFAULT);
    if (ret != CL_SUCCESS) {
        printf("Error al inicializar el motor de ClamAV: %s\n", cl_strerror(ret));
        exit(EXIT_FAILURE);
    }
    engine = cl_engine_new();
    if (!engine) {
        printf("Error al crear un nuevo motor de análisis de ClamAV.\n");
        exit(EXIT_FAILURE);
    }
    ret = cl_engine_compile(engine);
    if (ret != CL_SUCCESS) {
        printf("Error al compilar la base de datos de definiciones de virus de ClamAV: %s\n", cl_strerror(ret));
        exit(EXIT_FAILURE);
    }

    // Escanear un archivo específico
    const char *filename = "/ruta/al/archivo/malicioso";
    struct cl_stat st;
    if (cl_stat(filename, &st) == -1) {
        printf("Error al obtener información del archivo: %s\n", filename);
        exit(EXIT_FAILURE);
    }
    const unsigned char *file_content = cl_load(filename, &st.st_size);
    if (!file_content) {
        printf("Error al cargar el contenido del archivo: %s\n", filename);
        exit(EXIT_FAILURE);
    }
    ret = cl_scanmem(file_content, st.st_size, &virname, &fdesc, engine, CL_SCAN_STDOPT);
    if (ret == CL_VIRUS) {
        printf("El archivo %s contiene malware: %s\n", filename, virname);
    } else if (ret == CL_CLEAN) {
        printf("El archivo %s es seguro.\n", filename);
    } else {
        printf("Error al escanear el archivo: %s\n", cl_strerror(ret));
    }
    cl_free(file_content);

    // Limpiar y salir
    cl_engine_free(engine);
    cl_cleanup();
    return 0;
}
